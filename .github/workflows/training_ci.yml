name: GPU Training Pipeline

on:
    push:
        branches: [main, sprint6/api-integration, develop]
        paths:
            - "scripts/training_loop.py"
            - "configs/training_configuration.yaml"
            - "requirements-training.txt"
            - ".github/workflows/training_ci.yml"
    schedule:
        - cron: "0 14 * * *" # Daily 2 PM UTC
    workflow_dispatch:

jobs:
    train-model:
        runs-on: [self-hosted, gpu, cuda-12]
        timeout-minutes: 480

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Python 3.11
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Install PyTorch GPU + dependencies
              run: |
                  pip install --upgrade pip setuptools wheel
                  pip install torch==2.1.0 torchvision==0.16.0 torchaudio==2.1.0 --index-url https://download.pytorch.org/whl/cu121
                  pip install -r requirements-training.txt

            - name: Verify GPU availability
              run: |
                  python -c "
                  import torch
                  assert torch.cuda.is_available(), 'CUDA not available!'
                  print(f'‚úÖ GPU: {torch.cuda.get_device_name(0)}')
                  print(f'‚úÖ CUDA Version: {torch.version.cuda}')
                  print(f'‚úÖ Memory: {torch.cuda.get_device_properties(0).total_memory / 1e9:.1f} GB')
                  "

            - name: Create directories
              run: |
                  mkdir -p checkpoints
                  mkdir -p reports
                  mkdir -p logs

            - name: Display system info
              run: |
                  nvidia-smi
                  python -c "import torch; print(f'PyTorch version: {torch.__version__}')"

            - name: Run training pipeline
              env:
                  CUDA_VISIBLE_DEVICES: "0"
                  PYTORCH_CUDA_ALLOC_CONF: max_split_size_mb:512
                  TORCH_HOME: /tmp/torch_cache
                  HUGGINGFACE_HUB_CACHE: /tmp/hf_cache
              run: |
                  python scripts/training_loop.py \
                    --config configs/training_configuration.yaml \
                    --checkpoint-dir checkpoints \
                    --metrics-output reports/training_metrics.json \
                    --log-file logs/training.log \
                    --run-number ${{ github.run_number }}

            - name: Generate training report
              if: always()
              run: |
                  python scripts/training_dashboard.py \
                    --metrics-file reports/training_metrics.json \
                    --output-file reports/training_report.txt

            - name: Upload model checkpoint
              if: success()
              uses: actions/upload-artifact@v3
              with:
                  name: model-checkpoint-${{ github.run_number }}
                  path: checkpoints/latest.pt
                  retention-days: 30
                  if-no-files-found: ignore

            - name: Upload training metrics
              if: always()
              uses: actions/upload-artifact@v3
              with:
                  name: training-metrics-${{ github.run_number }}
                  path: |
                      reports/training_metrics.json
                      reports/training_report.txt
                      logs/training.log
                  retention-days: 30
                  if-no-files-found: ignore

            - name: Upload training logs
              if: always()
              uses: actions/upload-artifact@v3
              with:
                  name: training-logs-${{ github.run_number }}
                  path: logs/
                  retention-days: 7
                  if-no-files-found: ignore

            - name: Sync checkpoint to S3
              if: success() && secrets.AWS_ACCESS_KEY_ID
              run: |
                  python scripts/training_artifact_sync.py \
                    --checkpoint checkpoints/latest.pt \
                    --metrics reports/training_metrics.json \
                    --s3-bucket ryzen-llm-checkpoints \
                    --run-number ${{ github.run_number }}
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  AWS_DEFAULT_REGION: us-east-1

            - name: Parse training metrics
              if: always()
              id: metrics
              run: |
                  python -c "
                  import json
                  try:
                      with open('reports/training_metrics.json', 'r') as f:
                          metrics = json.load(f)
                      print(f'::set-output name=final_loss::{metrics.get(\"final_loss\", \"N/A\")}')
                      print(f'::set-output name=final_lr::{metrics.get(\"final_lr\", \"N/A\")}')
                      print(f'::set-output name=total_duration::{metrics.get(\"total_duration_hours\", \"N/A\")}')
                  except Exception as e:
                      print(f'Warning: Could not parse metrics: {e}')
                  " || true

            - name: Notify success
              if: success()
              uses: slackapi/slack-github-action@v1
              with:
                  webhook-url: ${{ secrets.SLACK_WEBHOOK }}
                  payload: |
                      {
                        "text": "‚úÖ GPU Training Complete",
                        "blocks": [
                          {
                            "type": "section",
                            "text": {
                              "type": "mrkdwn",
                              "text": "*üöÄ Training Pipeline Succeeded*\nRun: ${{ github.run_number }}\nBranch: ${{ github.ref }}\nCommit: ${{ github.sha }}"
                            }
                          }
                        ]
                      }
              if-no-files-found: warn

            - name: Notify failure
              if: failure()
              uses: slackapi/slack-github-action@v1
              with:
                  webhook-url: ${{ secrets.SLACK_WEBHOOK }}
                  payload: |
                      {
                        "text": "‚ùå GPU Training Failed",
                        "blocks": [
                          {
                            "type": "section",
                            "text": {
                              "type": "mrkdwn",
                              "text": "*üî¥ Training Pipeline Failed*\nRun: ${{ github.run_number }}\nBranch: ${{ github.ref }}"
                            }
                          }
                        ]
                      }
              if-no-files-found: warn

    gtest-build:
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
            - uses: actions/checkout@v4

            - name: Setup C++
              run: |
                  sudo apt-get update
                  sudo apt-get install -y cmake g++ libgtest-dev

            - name: Build GTest
              run: |
                  cd /usr/src/gtest
                  sudo cmake .
                  sudo cmake --build .
                  sudo cp *.a /usr/lib

            - name: Configure CMake
              run: |
                  cmake -B build \
                    -DCMAKE_BUILD_TYPE=Release \
                    -DENABLE_TESTING=ON \
                    -DCMAKE_PREFIX_PATH=/usr/lib/cmake/GTest

            - name: Build project
              run: |
                  cmake --build build --config Release --parallel $(nproc)

            - name: Build tests
              run: |
                  cmake --build build --target all_tests

            - name: Run tests
              run: |
                  cd build
                  ctest --output-on-failure
